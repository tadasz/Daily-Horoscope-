<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>GATO ‚Äî Settings</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a1a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    .container { max-width: 520px; margin: 0 auto; padding: 30px 20px 60px; }
    
    header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 1.5em; margin-bottom: 8px; }
    .logo-icon { font-size: 1.2em; }
    .logo-text { font-weight: 700; color: #fbbf24; margin-left: 4px; }
    h1 { font-size: 1.3em; color: #e0e0e0; margin-bottom: 4px; }
    .desc { color: #666; font-size: 0.9em; }

    .loading { text-align: center; color: #888; padding: 40px; }
    .toast {
      display: none; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px;
      font-size: 0.9em; text-align: center;
    }
    .toast.error { background: rgba(220,38,38,0.1); color: #f87171; border: 1px solid rgba(220,38,38,0.2); }
    .toast.success { background: rgba(110,231,183,0.1); color: #6ee7b7; border: 1px solid rgba(110,231,183,0.2); }

    .section {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      margin-bottom: 16px;
    }

    .field { margin-bottom: 16px; }
    .field:last-child { margin-bottom: 0; }
    .field label {
      display: block;
      font-size: 0.85em;
      color: #aaa;
      margin-bottom: 6px;
    }
    .field input, .field select {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.95em;
      font-family: inherit;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: rgba(139,92,246,0.5);
    }
    .field select option { background: #1a1a2e; color: #e0e0e0; }

    /* Style cards (like quiz) */
    .style-options { display: flex; flex-direction: column; gap: 8px; }
    .style-card {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .style-card:hover { border-color: rgba(139,92,246,0.3); }
    .style-card.active {
      border-color: rgba(139,92,246,0.6);
      background: rgba(139,92,246,0.08);
    }
    .style-card input { display: none; }
    .style-icon { font-size: 1.3em; flex-shrink: 0; }
    .style-label { font-size: 0.9em; font-weight: 500; }
    .style-desc { font-size: 0.78em; color: #888; margin-top: 2px; }

    /* Checkbox group for focus */
    .check-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .check-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85em;
      transition: border-color 0.2s, background 0.2s;
    }
    .check-pill:hover { border-color: rgba(139,92,246,0.3); }
    .check-pill.active {
      border-color: rgba(139,92,246,0.5);
      background: rgba(139,92,246,0.1);
      color: #c4b5fd;
    }
    .check-pill input { display: none; }

    .save-btn {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      color: #fff; border: none; border-radius: 10px;
      font-size: 1em; font-weight: 600; cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
      margin-top: 8px;
    }
    .save-btn:hover { transform: translateY(-1px); }
    .save-btn:active { transform: scale(0.98); }
    .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    footer { margin-top: 40px; text-align: center; }
    footer a { color: #555; font-size: 0.8em; text-decoration: none; }
    footer a:hover { color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span class="logo-icon">üê±</span>
        <span class="logo-text">GATO</span>
      </div>
      <h1 id="pageTitle">Settings</h1>
      <p class="desc" id="pageDesc">Update your horoscope preferences</p>
    </header>

    <div class="loading" id="loading">Loading...</div>
    <div class="toast error" id="error"></div>
    <div class="toast success" id="success"></div>

    <form id="settingsForm" style="display:none;">

      <!-- Profile -->
      <div class="section">
        <div class="section-title" id="sec_profile">Profile</div>
        <div class="field">
          <label id="lbl_name">Name</label>
          <input type="text" id="name" name="name">
        </div>
        <div class="field">
          <label id="lbl_gender">Gender</label>
          <select id="gender" name="gender">
            <option value="">‚Äî</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label id="lbl_relationship">Relationship</label>
          <select id="quiz_relationship" name="quiz_relationship">
            <option value="">‚Äî</option>
            <option value="single">Single</option>
            <option value="dating">Dating</option>
            <option value="relationship">In a relationship</option>
            <option value="married">Married</option>
            <option value="complicated">It's complicated</option>
          </select>
        </div>
        <div class="field">
          <label id="lbl_language">Language</label>
          <select id="language" name="language">
            <option value="en">English</option>
            <option value="lt">Lietuvi≈≥</option>
          </select>
        </div>
      </div>

      <!-- Birth data -->
      <div class="section">
        <div class="section-title" id="sec_birth">Birth Data</div>
        <div class="field">
          <label id="lbl_birth_date">Birth date</label>
          <input type="date" id="birth_date" name="birth_date">
        </div>
        <div class="field">
          <label id="lbl_birth_time">Birth time <span style="color:#555">(optional, improves accuracy)</span></label>
          <input type="time" id="birth_time" name="birth_time">
        </div>
        <div class="field">
          <label id="lbl_birth_city">Birth city</label>
          <input type="text" id="birth_city" name="birth_city" placeholder="e.g., Vilnius, Lithuania">
        </div>
      </div>

      <!-- Oracle style -->
      <div class="section">
        <div class="section-title" id="sec_style">Your Oracle</div>
        <div class="style-options" id="styleOptions">
          <label class="style-card" data-value="mystic">
            <input type="radio" name="quiz_style" value="mystic">
            <span class="style-icon">üåô</span>
            <div>
              <div class="style-label" data-i18n="style_mystic">The Seer ‚Äî mystic & poetic</div>
              <div class="style-desc" data-i18n="style_mystic_desc">Rich metaphors, cosmic storytelling</div>
            </div>
          </label>
          <label class="style-card" data-value="practical">
            <input type="radio" name="quiz_style" value="practical">
            <span class="style-icon">üî¨</span>
            <div>
              <div class="style-label" data-i18n="style_practical">The Strategist ‚Äî grounded & practical</div>
              <div class="style-desc" data-i18n="style_practical_desc">Data-driven, actionable insights</div>
            </div>
          </label>
          <label class="style-card" data-value="casual">
            <input type="radio" name="quiz_style" value="casual">
            <span class="style-icon">üí¨</span>
            <div>
              <div class="style-label" data-i18n="style_casual">The Friend ‚Äî casual & warm</div>
              <div class="style-desc" data-i18n="style_casual_desc">Like a wise friend over coffee</div>
            </div>
          </label>
          <label class="style-card" data-value="direct">
            <input type="radio" name="quiz_style" value="direct">
            <span class="style-icon">üî•</span>
            <div>
              <div class="style-label" data-i18n="style_direct">The Commander ‚Äî direct & bold</div>
              <div class="style-desc" data-i18n="style_direct_desc">No fluff, straight to the point</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Reading preferences -->
      <div class="section">
        <div class="section-title" id="sec_reading">Reading Preferences</div>
        <div class="field" id="lengthField">
          <label id="lbl_length">Reading length <span class="premium-badge" id="premiumBadge" style="font-size:0.8em;color:#fbbf24;display:none;">‚ú® Premium</span></label>
          <select id="quiz_length" name="quiz_length">
            <option value="">‚Äî</option>
            <option value="short">Short ‚Äî quick cosmic hit (~80 words)</option>
            <option value="medium">Medium ‚Äî balanced (~150 words)</option>
            <option value="long">Long ‚Äî deep dive (~250 words)</option>
          </select>
        </div>
        <div class="field">
          <label id="lbl_focus">Focus areas</label>
          <div class="check-group" id="focusGroup">
            <label class="check-pill"><input type="checkbox" name="focus" value="love"> ‚ù§Ô∏è Love</label>
            <label class="check-pill"><input type="checkbox" name="focus" value="career"> üíº Career</label>
            <label class="check-pill"><input type="checkbox" name="focus" value="health"> üåø Health</label>
            <label class="check-pill"><input type="checkbox" name="focus" value="growth"> üå± Growth</label>
            <label class="check-pill"><input type="checkbox" name="focus" value="money"> üí∞ Money</label>
          </div>
        </div>
      </div>

      <button type="submit" class="save-btn" id="saveBtn">Save Settings</button>
    </form>

    <footer>
      <a href="/" id="backLink">‚Üê Back to GATO</a>
    </footer>
  </div>

  <script>
    const pathParts = window.location.pathname.split('/');
    const token = pathParts[pathParts.length - 1];
    const params = new URLSearchParams(window.location.search);
    let lang = params.get('lang') || 'en';

    const i18n = {
      lt: {
        pageTitle: 'Nustatymai',
        pageDesc: 'Atnaujink savo horoskopo nuostatas',
        sec_profile: 'Profilis',
        sec_birth: 'Gimimo duomenys',
        sec_style: 'Tavo Orakulas',
        sec_reading: 'Skaitymo nuostatos',
        lbl_name: 'Vardas',
        lbl_gender: 'Lytis',
        lbl_relationship: 'Santykiai',
        lbl_language: 'Kalba',
        lbl_birth_date: 'Gimimo data',
        lbl_birth_time: 'Gimimo laikas <span style="color:#555">(neprivaloma, tikslesniam ≈æemƒólapiui)</span>',
        lbl_birth_city: 'Gimimo miestas',
        lbl_length: 'Skaitymo ilgis',
        lbl_focus: 'Fokuso sritys',
        style_mystic: 'Regƒótoja ‚Äî mistinƒó ir poeti≈°ka',
        style_mystic_desc: 'Turtingos metaforos, kosminis pasakojimas',
        style_practical: 'Strategƒó ‚Äî prakti≈°ka ir konkreti',
        style_practical_desc: 'Duomenimis pagrƒØstos, veiksmingos ƒØ≈ævalgos',
        style_casual: 'Draugƒó ‚Äî ≈°ilta ir artima',
        style_casual_desc: 'Kaip i≈°mintinga draugƒó prie kavos',
        style_direct: 'Vadƒó ‚Äî tiesmuka ir drƒÖsi',
        style_direct_desc: 'Be apvalkal≈≥, tiesiai ƒØ esmƒô',
        saveBtn: 'I≈°saugoti',
        backLink: '‚Üê GrƒØ≈æti ƒØ GATO',
        saved: 'Nustatymai i≈°saugoti!',
        gender_female: 'Moteris',
        gender_male: 'Vyras',
        gender_other: 'Kita',
        rel_single: 'Vienas/viena',
        rel_dating: 'Susitinkinƒóju',
        rel_relationship: 'Santykiuose',
        rel_married: 'Vedƒôs/i≈°tekƒójusi',
        rel_complicated: 'Sudƒótinga',
        len_short: 'Trumpas ‚Äî greitas kosminis blyksnis',
        len_medium: 'Vidutinis ‚Äî subalansuotas',
        len_long: 'Ilgas ‚Äî gilus pasinƒórimas',
      }
    };

    function applyI18n() {
      if (lang !== 'lt') return;
      const t = i18n.lt;
      const set = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };
      set('pageTitle', t.pageTitle);
      set('pageDesc', t.pageDesc);
      set('sec_profile', t.sec_profile);
      set('sec_birth', t.sec_birth);
      set('sec_style', t.sec_style);
      set('sec_reading', t.sec_reading);
      set('lbl_name', t.lbl_name);
      set('lbl_gender', t.lbl_gender);
      set('lbl_relationship', t.lbl_relationship);
      set('lbl_language', t.lbl_language);
      set('lbl_birth_date', t.lbl_birth_date);
      set('lbl_birth_time', t.lbl_birth_time);
      set('lbl_birth_city', t.lbl_birth_city);
      set('lbl_length', t.lbl_length);
      set('lbl_focus', t.lbl_focus);
      set('saveBtn', t.saveBtn);
      set('backLink', t.backLink);

      // Gender options
      const g = document.getElementById('gender');
      g.options[1].text = t.gender_female;
      g.options[2].text = t.gender_male;
      g.options[3].text = t.gender_other;

      // Relationship options
      const r = document.getElementById('quiz_relationship');
      r.options[1].text = t.rel_single;
      r.options[2].text = t.rel_dating;
      r.options[3].text = t.rel_relationship;
      r.options[4].text = t.rel_married;
      r.options[5].text = t.rel_complicated;

      // Length options
      const l = document.getElementById('quiz_length');
      l.options[1].text = t.len_short;
      l.options[2].text = t.len_medium;
      l.options[3].text = t.len_long;

      // Style cards
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.textContent = t[key];
      });
    }

    // Style card click handling
    document.querySelectorAll('.style-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.style-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        card.querySelector('input').checked = true;
      });
    });

    // Focus pill click handling
    document.querySelectorAll('.check-pill').forEach(pill => {
      pill.addEventListener('click', (e) => {
        e.preventDefault();
        const cb = pill.querySelector('input');
        cb.checked = !cb.checked;
        pill.classList.toggle('active', cb.checked);
      });
    });

    async function loadSettings() {
      try {
        const res = await fetch(`/api/settings/${token}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        // Set language from data, then apply i18n
        lang = data.language || lang;
        applyI18n();

        // Populate fields
        document.getElementById('name').value = data.name || '';
        document.getElementById('language').value = data.language || 'en';
        document.getElementById('gender').value = data.gender || '';
        document.getElementById('quiz_relationship').value = data.quiz_relationship || '';
        document.getElementById('birth_date').value = data.birth_date || '';
        document.getElementById('birth_time').value = data.birth_time || '';
        document.getElementById('birth_city').value = data.birth_city || '';
        document.getElementById('quiz_length').value = data.quiz_length || '';

        // Length ‚Äî premium only
        if (!data.premium) {
          document.getElementById('quiz_length').disabled = true;
          document.getElementById('premiumBadge').style.display = 'inline';
        }

        // Style
        if (data.quiz_style) {
          const card = document.querySelector(`.style-card[data-value="${data.quiz_style}"]`);
          if (card) {
            card.classList.add('active');
            card.querySelector('input').checked = true;
          }
        }

        // Focus areas (comma-separated)
        if (data.focus_area) {
          const areas = data.focus_area.split(',');
          areas.forEach(a => {
            const cb = document.querySelector(`input[name="focus"][value="${a.trim()}"]`);
            if (cb) { cb.checked = true; cb.closest('.check-pill').classList.add('active'); }
          });
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('settingsForm').style.display = 'block';
      } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showToast('error', e.message);
      }
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.textContent = '...';

      const focusAreas = [...document.querySelectorAll('input[name="focus"]:checked')]
        .map(cb => cb.value).join(',');

      const style = document.querySelector('input[name="quiz_style"]:checked');

      const body = {
        name: document.getElementById('name').value,
        language: document.getElementById('language').value,
        gender: document.getElementById('gender').value,
        quiz_relationship: document.getElementById('quiz_relationship').value,
        birth_date: document.getElementById('birth_date').value,
        birth_time: document.getElementById('birth_time').value,
        birth_city: document.getElementById('birth_city').value,
        quiz_style: style ? style.value : null,
        quiz_length: document.getElementById('quiz_length').value,
        focus_area: focusAreas || null,
      };

      try {
        const res = await fetch(`/api/settings/${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showToast('success', lang === 'lt' ? 'Nustatymai i≈°saugoti!' : 'Settings saved!');
      } catch (e) {
        showToast('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = lang === 'lt' ? 'I≈°saugoti' : 'Save Settings';
      }
    });

    function showToast(type, msg) {
      ['error', 'success'].forEach(t => document.getElementById(t).style.display = 'none');
      const el = document.getElementById(type);
      el.textContent = msg;
      el.style.display = 'block';
      if (type === 'success') setTimeout(() => el.style.display = 'none', 3000);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    if (!token || token === 'settings' || token === 'settings.html') {
      document.getElementById('loading').textContent = 'Invalid settings link.';
    } else {
      loadSettings();
    }
  </script>
</body>
</html>

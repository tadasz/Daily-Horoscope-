<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GATO ‚Äî Reading the Stars...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a1a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .container {
      text-align: center;
      max-width: 480px;
      width: 100%;
      padding: 40px 24px;
    }
    .icon-wrap {
      font-size: 4em;
      margin-bottom: 28px;
      animation: float 2.5s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    
    h1 { font-size: 1.5em; margin-bottom: 12px; font-weight: 600; }
    .status-text {
      color: #999; font-size: 1.05em; line-height: 1.6;
      margin-bottom: 28px; min-height: 2em;
    }
    .steps {
      text-align: left;
      max-width: 320px;
      margin: 0 auto;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      font-size: 0.95em;
      color: #444;
      transition: color 0.5s;
      position: relative;
    }
    .step.active { color: #c4b5fd; }
    .step.done { color: #6ee7b7; }
    .step-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .step-content { flex: 1; }
    .step-label { font-weight: 500; }
    
    /* Progress bar per step */
    .step-bar {
      height: 3px;
      background: rgba(139, 92, 246, 0.15);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .step.active .step-bar { opacity: 1; }
    .step-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #8b5cf6, #c4b5fd);
      border-radius: 2px;
      transition: width 0.5s ease-out;
    }
    
    .spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-top-color: #8b5cf6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .circle { color: #333; font-size: 1.2em; }
    .check { color: #6ee7b7; font-size: 1.1em; }

    /* Done state */
    .done-view { display: none; }
    .done-view h1 { color: #6ee7b7; }
    .done-emoji { font-size: 3em; margin-bottom: 16px; }
    .check-email {
      background: rgba(110, 231, 183, 0.1);
      border: 1px solid rgba(110, 231, 183, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }
    .check-email p { color: #999; font-size: 0.9em; margin-top: 8px; }
    .spam-note {
      color: #666; font-size: 0.85em;
      margin-top: 16px; font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading-view">
      <div class="icon-wrap">üî≠</div>
      <h1 id="title">Reading the stars...</h1>
      <p class="status-text" id="status-text">We're calculating your unique cosmic blueprint</p>
      
      <div class="steps">
        <div class="step" id="step1">
          <span class="step-icon"><span class="circle">‚óã</span></span>
          <div class="step-content">
            <div class="step-label" id="step1-text">Mapping your natal chart</div>
            <div class="step-bar"><div class="step-bar-fill" id="bar1"></div></div>
          </div>
        </div>
        <div class="step" id="step2">
          <span class="step-icon"><span class="circle">‚óã</span></span>
          <div class="step-content">
            <div class="step-label" id="step2-text">Reading planetary aspects</div>
            <div class="step-bar"><div class="step-bar-fill" id="bar2"></div></div>
          </div>
        </div>
        <div class="step" id="step3">
          <span class="step-icon"><span class="circle">‚óã</span></span>
          <div class="step-content">
            <div class="step-label" id="step3-text">Writing your personal reading</div>
            <div class="step-bar"><div class="step-bar-fill" id="bar3"></div></div>
          </div>
        </div>
        <div class="step" id="step4">
          <span class="step-icon"><span class="circle">‚óã</span></span>
          <div class="step-content">
            <div class="step-label" id="step4-text">Sending to your inbox</div>
            <div class="step-bar"><div class="step-bar-fill" id="bar4"></div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="done-view" id="done-view">
      <div class="done-emoji">‚ú®</div>
      <h1 id="done-title">Your cosmic blueprint is ready!</h1>
      <div class="check-email">
        <p style="font-size: 1.1em; color: #e0e0e0; margin: 0;" id="done-text">Check your email for your personalized reading</p>
        <p id="done-sub">Your first daily horoscope arrives tomorrow morning</p>
      </div>
      <p class="spam-note" id="spam-note">üìÆ Don't see it? Check your spam/junk folder and mark GATO as "not spam"</p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const lang = params.get('lang') || 'en';
    const token = window.location.pathname.split('/').pop().split('?')[0];

    const lt = {
      title: 'Skaitome ≈ævaig≈ædes...',
      statusText: 'Skaitome tavo unikal≈≥ kosminƒØ portretƒÖ',
      step1: 'Brai≈æome tavo gimimo horoskopƒÖ',
      step2: 'Nagrinƒójame planet≈≥ aspektus',
      step3: 'Ra≈°ome tavo asmeninƒØ horoskopƒÖ',
      step4: 'Siunƒçiame tau lai≈°kƒÖ',
      doneTitle: 'Tavo kosminis portretas paruo≈°tas!',
      doneText: 'Pasitikrink savo el. pa≈°tƒÖ ‚Äî ten tavƒôs laukia asmeninis horoskopas',
      doneSub: 'Pirmasis kasdieninis skaitymas atkeliaus rytoj ryte',
      spamNote: 'üìÆ Nematai lai≈°ko? Patikrink ≈°lam≈°to (spam) aplankƒÖ ir pa≈æymƒók GATO kaip ‚Äûne ≈°lam≈°tas"',
    };

    if (lang === 'lt') {
      document.documentElement.lang = 'lt';
      document.getElementById('title').textContent = lt.title;
      document.getElementById('status-text').textContent = lt.statusText;
      document.getElementById('step1-text').textContent = lt.step1;
      document.getElementById('step2-text').textContent = lt.step2;
      document.getElementById('step3-text').textContent = lt.step3;
      document.getElementById('step4-text').textContent = lt.step4;
      document.getElementById('done-title').textContent = lt.doneTitle;
      document.getElementById('done-text').textContent = lt.doneText;
      document.getElementById('done-sub').textContent = lt.doneSub;
      document.getElementById('spam-note').textContent = lt.spamNote;
    }

    let finished = false;

    // Step durations in ms ‚Äî total ~30s for Opus welcome generation
    const stepDurations = [5000, 8000, 12000, 7000]; // 5s, 8s, 12s, 7s
    let currentStep = 0;

    function startStep(n) {
      if (finished) return;
      currentStep = n;
      const step = document.getElementById(`step${n}`);
      const bar = document.getElementById(`bar${n}`);
      if (!step) return;
      
      step.classList.add('active');
      step.querySelector('.step-icon').innerHTML = '<span class="spinner"></span>';
      
      // Animate progress bar
      const duration = stepDurations[n - 1];
      let progress = 0;
      const interval = setInterval(() => {
        if (finished || currentStep !== n) { clearInterval(interval); return; }
        progress += 100 / (duration / 200);
        if (progress > 95) progress = 95; // never quite finish until done
        bar.style.width = progress + '%';
      }, 200);
    }

    function completeStep(n) {
      const step = document.getElementById(`step${n}`);
      const bar = document.getElementById(`bar${n}`);
      if (!step) return;
      step.classList.remove('active');
      step.classList.add('done');
      step.querySelector('.step-icon').innerHTML = '<span class="check">‚úì</span>';
      bar.style.width = '100%';
    }

    // Start step 1 immediately
    startStep(1);

    // Schedule step transitions
    let elapsed = 0;
    for (let i = 0; i < stepDurations.length - 1; i++) {
      elapsed += stepDurations[i];
      const nextStep = i + 2;
      setTimeout(() => {
        if (finished) return;
        completeStep(nextStep - 1);
        startStep(nextStep);
      }, elapsed);
    }

    function showDone() {
      finished = true;
      // Complete all steps
      for (let i = 1; i <= 4; i++) completeStep(i);
      setTimeout(() => {
        document.getElementById('loading-view').style.display = 'none';
        document.getElementById('done-view').style.display = 'block';
      }, 600);
    }

    // Poll for status
    let pollCount = 0;
    const pollInterval = setInterval(async () => {
      pollCount++;
      try {
        const res = await fetch(`/api/welcome-status/${token}`);
        const data = await res.json();
        if (data.status === 'sent' || data.status === 'error') {
          clearInterval(pollInterval);
          showDone();
        }
      } catch (e) {}
      if (pollCount > 45) { // 90s timeout
        clearInterval(pollInterval);
        showDone();
      }
    }, 2000);
  </script>
</body>
</html>
